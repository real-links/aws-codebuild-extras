#!/bin/sh

export CI=true
export CODEBUILD=true
export CODEBUILDEXTRAS=true

export CODEBUILDEXTRAS_ACCOUNT_ID=$(aws sts get-caller-identity --query 'Account' --output text)
if [ "$CODEBUILDEXTRAS_GIT_BRANCH" = "" ]; then
  export CODEBUILDEXTRAS_GIT_BRANCH="$(git symbolic-ref HEAD --short 2>/dev/null)"
fi
if [ "$CODEBUILDEXTRAS_GIT_BRANCH" = "" ]; then
  CODEBUILDEXTRAS_GIT_BRANCH="$(git branch -a --contains HEAD 2>/dev/null | sed -n 2p | awk '{ printf $1 }')";
  export CODEBUILDEXTRAS_GIT_BRANCH=${CODEBUILDEXTRAS_GIT_BRANCH#remotes/origin/};
fi
export CODEBUILDEXTRAS_GIT_CLEAN_BRANCH="$(echo $CODEBUILDEXTRAS_GIT_BRANCH | tr '/' '-')"
export CODEBUILDEXTRAS_GIT_ESCAPED_BRANCH="$(echo $CODEBUILDEXTRAS_GIT_CLEAN_BRANCH | sed -e 's/[]\/$*.^[]/\\\\&/g')"

export CODEBUILDEXTRAS_GIT_COMMIT="$(git log -1 --pretty=%H 2>/dev/null)"
if [ "$CODEBUILDEXTRAS_GIT_COMMIT" = "" ]; then
  export CODEBUILDEXTRAS_GIT_COMMIT="$CODEBUILD_RESOLVED_SOURCE_VERSION"
fi
export CODEBUILDEXTRAS_GIT_SHORT_COMMIT="$(echo $CODEBUILDEXTRAS_GIT_COMMIT | cut -c 1-8)"

export CODEBUILDEXTRAS_PROJECT=${CODEBUILD_BUILD_ID%:$CODEBUILD_LOG_PATH}
export CODEBUILDEXTRAS_BUILD_URL=https://$AWS_REGION.console.aws.amazon.com/codebuild/home?region=$AWS_REGION#/builds/$CODEBUILD_BUILD_ID/view/new

echo "==> AWS CodeBuild Extra Environment Variables:"
echo "==> CI = $CI"
echo "==> CODEBUILD = $CODEBUILD"
echo "==> CODEBUILDEXTRAS = $CODEBUILDEXTRAS"
echo "==> CODEBUILDEXTRAS_ACCOUNT_ID = $CODEBUILDEXTRAS_ACCOUNT_ID"
echo "==> CODEBUILDEXTRAS_GIT_BRANCH = $CODEBUILDEXTRAS_GIT_BRANCH"
echo "==> CODEBUILDEXTRAS_GIT_CLEAN_BRANCH = $CODEBUILDEXTRAS_GIT_CLEAN_BRANCH"
echo "==> CODEBUILDEXTRAS_GIT_ESCAPED_BRANCH = $CODEBUILDEXTRAS_GIT_ESCAPED_BRANCH"
echo "==> CODEBUILDEXTRAS_GIT_COMMIT = $CODEBUILDEXTRAS_GIT_COMMIT"
echo "==> CODEBUILDEXTRAS_GIT_SHORT_COMMIT = $CODEBUILDEXTRAS_GIT_SHORT_COMMIT"
echo "==> CODEBUILDEXTRAS_PROJECT = $CODEBUILDEXTRAS_PROJECT"
echo "==> CODEBUILDEXTRAS_BUILD_URL = $CODEBUILDEXTRAS_BUILD_URL"
